name: Auto + Bugbot Collaboration

on:
  pull_request:
    types: [opened, synchronize, review_requested]
  issue_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  workflow_dispatch: # Allow manual trigger

jobs:
  auto-respond:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' && 
      (contains(github.event.comment.body, 'bugbot') || 
       contains(github.event.comment.body, 'issue') ||
       contains(github.event.comment.body, 'suggestion') ||
       github.event.comment.user.type == 'Bot') ||
      github.event.review.state == 'changes_requested' ||
      github.event.review.state == 'commented'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Read PR comments and reviews
        id: read-feedback
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            // Combine comments and reviews
            const allFeedback = [
              ...comments.map(c => ({ type: 'comment', ...c })),
              ...reviews.map(r => ({ type: 'review', ...r }))
            ];
            
            // Filter for bot/reviewer feedback
            const relevantFeedback = allFeedback.filter(f => 
              f.user.type === 'Bot' || 
              f.body?.toLowerCase().includes('bugbot') ||
              f.body?.toLowerCase().includes('issue') ||
              f.body?.toLowerCase().includes('suggestion') ||
              f.state === 'changes_requested'
            );
            
            core.setOutput('feedback', JSON.stringify(relevantFeedback));
            core.setOutput('count', relevantFeedback.length);
            
            return relevantFeedback;

      - name: Process findings
        id: process
        run: |
          echo "ðŸ” Processing bugbot findings..."
          FEEDBACK_COUNT="${{ steps.read-feedback.outputs.count }}"
          
          if [ "$FEEDBACK_COUNT" -gt 0 ]; then
            echo "âœ… Found $FEEDBACK_COUNT items to process"
            echo "findings_count=$FEEDBACK_COUNT" >> $GITHUB_OUTPUT
            echo "has_findings=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸  No findings to process"
            echo "has_findings=false" >> $GITHUB_OUTPUT
          fi

      - name: Analyze code
        if: steps.process.outputs.has_findings == 'true'
        run: |
          echo "ðŸ” Running code analysis..."
          flutter analyze --no-fatal-infos || true
          echo "âœ… Analysis complete"

      - name: Create findings summary
        if: steps.process.outputs.has_findings == 'true'
        run: |
          mkdir -p .auto
          cat > .auto/findings_summary.md << EOF
          # Bugbot Findings Summary
          Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ## Feedback Items Found: ${{ steps.process.outputs.findings_count }}
          
          ## Next Steps
          Auto will process these findings and implement fixes automatically.
          
          See PR comments for details.
          EOF
          cat .auto/findings_summary.md

      - name: Create response comment
        if: steps.process.outputs.has_findings == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸ¤– **Auto here!** I've detected ${{ steps.process.outputs.findings_count }} feedback items from bugbot.
              
              âœ… I'm processing these findings now and will implement fixes automatically.
              
              ðŸ“‹ Next steps:
              1. Analyzing each finding
              2. Implementing fixes
              3. Creating fix commits
              4. Pushing to PR
              
              ðŸ”„ Bugbot will re-review automatically after fixes are pushed.
              
              ---
              *This is an automated response from the Auto + Bugbot collaboration system.*`
            });

      - name: Setup Git
        if: steps.process.outputs.has_findings == 'true'
        run: |
          git config --local user.email "auto@n3rd-game.com"
          git config --local user.name "Auto AI"

      - name: Commit findings summary
        if: steps.process.outputs.has_findings == 'true'
        run: |
          git add .auto/findings_summary.md || true
          git commit -m "auto: Process bugbot findings (${{ steps.process.outputs.findings_count }} items)" || echo "No changes to commit"
          git push || echo "Nothing to push"

  notify:
    runs-on: ubuntu-latest
    needs: auto-respond
    if: always()
    steps:
      - name: Notify completion
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ needs.auto-respond.result }}';
            const emoji = status === 'success' ? 'âœ…' : 'âš ï¸';
            console.log(`${emoji} Auto collaboration workflow completed with status: ${status}`);
